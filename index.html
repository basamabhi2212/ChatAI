<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavaBharath Daily Stock Automation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* UI/UX Design: Navy, Saffron, Green (Bullish), Red (Bearish) */
        :root {
            --navy: #1C2E4A;
            --saffron: #FF9933;
            --green-bullish: #4CAF50;
            --red-bearish: #F44336;
            --text-light: #F0F0F0;
            --text-dark: #333;
            --card-bg: #283E5B;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--navy);
            color: var(--text-light);
            margin: 0;
            padding-top: 60px; /* Space for fixed navbar */
        }

        /* Navbar/Menu Bar */
        .navbar {
            background-color: var(--card-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        .logo {
            color: var(--saffron);
            font-size: 1.5em;
            font-weight: bold;
            text-decoration: none;
        }
        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            margin-left: 20px;
            padding: 5px 10px;
            transition: color 0.3s;
        }
        .nav-links a:hover {
            color: var(--saffron);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Buttons */
        .main-button {
            background-color: var(--saffron);
            color: var(--navy);
            border: none;
            padding: 12px 25px;
            margin: 10px 10px 20px 0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, opacity 0.3s;
        }
        .main-button:hover:not(:disabled) {
            background-color: #FFB866;
        }
        .main-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loader */
        .loader-container {
            text-align: center;
            margin-top: 20px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
            height: 25px;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--green-bullish);
            transition: width 0.1s linear;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            color: var(--navy);
        }

        /* Stock List/Results */
        .stock-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stock-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            border-left: 5px solid var(--saffron);
        }
        .stock-card h3 {
            color: var(--saffron);
            border-bottom: 2px solid rgba(255, 153, 51, 0.3);
            padding-bottom: 5px;
            margin-top: 0;
        }
        .analysis-text {
            white-space: pre-wrap;
            background-color: #101d30;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .sentiment-bullish { color: var(--green-bullish); font-weight: bold; }
        .sentiment-bearish { color: var(--red-bearish); font-weight: bold; }
        .sentiment-sideways { color: var(--saffron); font-weight: bold; }
        .image-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-top: 10px;
            display: block;
            border: 1px solid var(--saffron);
        }
        .download-options button {
            background-color: var(--navy);
            color: var(--saffron);
            border: 1px solid var(--saffron);
            padding: 8px 15px;
            margin-right: 5px;
            margin-top: 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .download-options button:hover {
            background-color: var(--saffron);
            color: var(--navy);
        }
        .placeholder-image {
            width: 100%;
            height: 150px;
            background-color: #384f6d;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="logo">NavaBharath Daily</a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="about.html">About Us</a>
        </div>
    </nav>

    <div class="container">
        <h1>Daily Stock Automation Dashboard</h1>

        <div class="control-panel">
            <button class="main-button" id="runStocksBtn">Run Daily Stocks</button>
            <button class="main-button" id="generateAnalysisBtn" disabled>Generate Analysis</button>
        </div>
        
        <p>
            <small>
                <strong>NOTE:</strong> You must upload a chart image for each stock before running analysis. 
                API calls are mocked for simplicity and security. Replace the API functions with a secure backend.
            </small>
        </p>

        <div id="loader" class="loader-container" style="display:none;">
            <p id="loaderText">Picking 10 random stocks... (10 seconds)</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div id="stockListContainer" class="stock-list">
            </div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // ðŸ›‘ SECURITY WARNING: Exposing the API Key is highly insecure.
        // Use a secure backend proxy in production.
        // ------------------------------------------------------------------
        const API_KEY = "AIzaSyBnRZZ7XVr6VkCmSYuY29wDf1Ne5koFes4"; // **REPLACE THIS**
        
        // Official Google AI Endpoints (using common models for demonstration)
        const TEXT_MODEL = "gemini-2.5-flash"; // Multimodal analysis
        const IMAGE_MODEL = "imagen-3.0-generate-002"; // Image generation
        
        const API_URL_GENERATE = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${API_KEY}`;
        const API_URL_IMAGES = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:generateImages?key=${API_KEY}`;
        
        // Mock array of NSE/BSE stocks
        const ALL_STOCKS = [
            'Reliance Industries', 'Tata Consultancy Services', 'HDFC Bank', 
            'Infosys', 'Hindustan Unilever', 'ICICI Bank', 'State Bank of India',
            'Kotak Mahindra Bank', 'Bajaj Finance', 'Larsen & Toubro', 'Bharti Airtel',
            'Axis Bank', 'Titan Company', 'Asian Paints', 'Maruti Suzuki India'
        ];

        let selectedStocks = [];

        const runStocksBtn = document.getElementById('runStocksBtn');
        const generateAnalysisBtn = document.getElementById('generateAnalysisBtn');
        const loader = document.getElementById('loader');
        const progressBar = document.getElementById('progressBar');
        const stockListContainer = document.getElementById('stockListContainer');

        // --- Core API Functions (MOCKED) ---

        /**
         * Mocks the Gemini Stock Analysis API Call (Multimodal: Text + Image).
         * NOTE: The actual `fetch` call for multimodal input is complex and omitted 
         * here for a working client-side demo using a mock return.
         */
        async function getStockAnalysis(stockName, chartBase64) {
            console.log(`Simulating Gemini analysis for ${stockName}... (Using ${TEXT_MODEL})`);
            
            // Mock API call simulation
            await new Promise(resolve => setTimeout(resolve, 1500)); 

            // Mock Data that mirrors what the Gemini API would return
            const mockResults = [
                { sentiment: 'Bullish', summary: `${stockName} shows strong breakout volume. Potential for a major rally.`, 
                  analysis: "1) Recommendation: Buy\n2) Support: 2400, Resistance: 2650\n3) Target: 2600, Stop-loss: 2450\n4) One-line YouTube summary: ðŸ”¥ ${stockName} BREAKOUT! Is a 20% rally coming?" },
                { sentiment: 'Bearish', summary: `${stockName} is forming a Head and Shoulders pattern. Short-term downside expected.`,
                  analysis: "1) Recommendation: Avoid\n2) Support: 850, Resistance: 920\n3) Target: 820, Stop-loss: 900\n4) One-line YouTube summary: ðŸš¨ SELL ALERT on ${stockName}. Head and Shoulders pattern confirms decline." },
                { sentiment: 'Sideways', summary: `${stockName} stuck in a tight consolidation range. Wait for clear direction.`,
                  analysis: "1) Recommendation: Hold\n2) Support: 1500, Resistance: 1600\n3) Target: N/A, Stop-loss: N/A\n4) One-line YouTube summary: ðŸ˜´ ${stockName} is flat. Don't trade until a breakout happens." }
            ];
            
            const randomResult = mockResults[Math.floor(Math.random() * mockResults.length)];
            
            return {
                sentiment: randomResult.sentiment,
                analysis: randomResult.analysis.replace(/\$\{stockName\}/g, stockName),
                summary: randomResult.summary.replace(/\$\{stockName\}/g, stockName)
            };
        }

        /**
         * Mocks the Gemini Social Image Generation API Call (Imagen).
         */
        async function generateSocialImage(stockName, oneLineSummary) {
            console.log(`Simulating Gemini image generation for ${stockName}... (Using ${IMAGE_MODEL})`);
            
            // Mock API call simulation
            await new Promise(resolve => setTimeout(resolve, 1000)); 

            // Return a placeholder image URL
            const placeholderUrl = `https://via.placeholder.com/1080x1350/1C2E4A/FF9933?text=${encodeURIComponent(stockName)}%0ADaily%20Snapshot%0A${encodeURIComponent(oneLineSummary)}%0A(Mock%20Image)`;
            return placeholderUrl; 
        }
        
        // --- Automation Logic ---

        function runDailyStocks() {
            runStocksBtn.disabled = true;
            generateAnalysisBtn.disabled = true;
            stockListContainer.innerHTML = '';
            loader.style.display = 'block';
            progressBar.style.width = '0%';
            
            // 10-second loader simulation
            const duration = 10000;
            const interval = 100;
            let currentProgress = 0;

            const progressInterval = setInterval(() => {
                currentProgress += (interval / duration) * 100;
                progressBar.style.width = `${currentProgress}%`;
                progressBar.textContent = `${Math.round(currentProgress)}%`;

                if (currentProgress >= 100) {
                    clearInterval(progressInterval);
                    loader.style.display = 'none';
                    
                    // Pick 10 random stocks
                    selectedStocks = [];
                    const tempStocks = [...ALL_STOCKS];
                    for (let i = 0; i < 10; i++) {
                        const randomIndex = Math.floor(Math.random() * tempStocks.length);
                        selectedStocks.push(tempStocks.splice(randomIndex, 1)[0]);
                    }

                    displayStocks(selectedStocks);
                    generateAnalysisBtn.disabled = false;
                }
            }, interval);
        }

        function displayStocks(stocks) {
            stocks.forEach(stockName => {
                const safeName = stockName.replace(/\s/g, '');
                const stockCardHTML = `
                    <div class="stock-card" id="card-${safeName}">
                        <h3>${stockName}</h3>
                        <div class="content-area">
                            <p>Status: <span id="status-${safeName}">Ready for Analysis</span></p>
                            
                            <div class="placeholder-image">Chart Placeholder (Upload Required)</div>
                            <input type="file" accept="image/*" class="chart-upload-input" data-stock="${stockName}" data-mimetype="" style="display: block; margin-bottom: 10px;">
                            
                            <div class="results" style="display:none;">
                                <small>Generated: <span class="datetime"></span></small>
                                
                                <h4>Analysis (<span class="sentiment">N/A</span>)</h4>
                                <pre class="analysis-text">Run analysis to see results...</pre>
                                
                                <h4>Social Image Preview</h4>
                                <div class="image-preview">
                                    <img src="" alt="Social Image Preview" style="display: none;">
                                </div>
                                
                                <div class="download-options">
                                    <button class="download-btn" data-type="screenshot" disabled>Download Chart</button>
                                    <button class="download-btn" data-type="social" disabled>Download Social Image</button>
                                    <button class="download-btn" data-type="pdf" disabled>Download Stock PDF</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                stockListContainer.innerHTML += stockCardHTML;
            });

            // Attach event listener for chart upload
            document.querySelectorAll('.chart-upload-input').forEach(input => {
                input.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const card = document.getElementById(`card-${event.target.dataset.stock.replace(/\s/g, '')}`);
                            const placeholder = card.querySelector('.placeholder-image');
                            
                            // Remove placeholder or existing chart image
                            let existingChart = card.querySelector('.original-chart');
                            if (existingChart) existingChart.remove();
                            if (placeholder) placeholder.remove();
                            
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.classList.add('original-chart');
                            
                            // Re-insert the upload input for UI positioning
                            const uploadInput = event.target;
                            
                            // Insert the new chart image before the upload input
                            uploadInput.parentNode.insertBefore(img, uploadInput);
                            
                            // Store Base64 and MIME Type for API call
                            uploadInput.dataset.chartBase64 = e.target.result.split(',')[1];
                            uploadInput.dataset.mimetype = file.type;
                            uploadInput.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        }

        async function generateAnalysis() {
            generateAnalysisBtn.disabled = true;
            runStocksBtn.disabled = true;
            
            const stocksToAnalyze = selectedStocks.map(stockName => {
                const safeName = stockName.replace(/\s/g, '');
                const card = document.getElementById(`card-${safeName}`);
                const uploadInput = card.querySelector(`.chart-upload-input`);
                const chartBase64 = uploadInput ? uploadInput.dataset.chartBase64 : null;
                const statusSpan = document.getElementById(`status-${safeName}`);

                if (!chartBase64) {
                    statusSpan.textContent = 'Analysis Blocked: Chart Missing!';
                    return null; // Skip if no chart is uploaded
                }
                return { stockName, safeName, card, statusSpan, chartBase64 };
            }).filter(s => s !== null);

            for (const stock of stocksToAnalyze) {
                const { stockName, safeName, card, statusSpan, chartBase64 } = stock;
                const resultsDiv = card.querySelector('.results');
                const analysisText = card.querySelector('.analysis-text');
                const sentimentSpan = card.querySelector('.sentiment');
                const socialImg = card.querySelector('.image-preview img');
                const datetimeSpan = card.querySelector('.datetime');
                const originalChart = card.querySelector(`.original-chart`);
                
                statusSpan.textContent = 'Analyzing...';
                resultsDiv.style.display = 'block';

                try {
                    // 1. Stock Analysis API Call (MOCKED)
                    const analysisData = await getStockAnalysis(stockName, chartBase64);
                    
                    // 2. Social Image Generation API Call (MOCKED)
                    const imageUrl = await generateSocialImage(stockName, analysisData.summary);
                    
                    // 3. Display Results
                    datetimeSpan.textContent = new Date().toLocaleString();
                    analysisText.textContent = analysisData.analysis;
                    sentimentSpan.textContent = analysisData.sentiment;
                    sentimentSpan.className = `sentiment sentiment-${analysisData.sentiment.toLowerCase()}`;
                    socialImg.src = imageUrl;
                    socialImg.style.display = 'block';

                    // 4. Update Download Links
                    const downloadBtns = card.querySelectorAll('.download-btn');
                    downloadBtns.forEach(btn => {
                        btn.disabled = false;
                        btn.onclick = () => handleDownload(stockName, btn.dataset.type, originalChart.src, socialImg.src, card);
                    });

                    statusSpan.textContent = 'Analysis Complete';
                } catch (error) {
                    console.error(`Error analyzing ${stockName}:`, error);
                    statusSpan.textContent = `Analysis Failed: ${error.message}`;
                }
            }

            generateAnalysisBtn.disabled = false;
            runStocksBtn.disabled = false;
        }

        function handleDownload(stockName, type, chartSrc, socialSrc, cardElement) {
            const safeName = stockName.replace(/\s/g, '_');
            
            if (type === 'screenshot' && chartSrc) {
                downloadFile(chartSrc, `${safeName}_Chart.png`);
            } else if (type === 'social' && socialSrc) {
                downloadFile(socialSrc, `${safeName}_SocialImage.png`);
            } else if (type === 'pdf') {
                // PDF generation using html2pdf.js
                const element = cardElement.cloneNode(true);
                // Clean up the cloned element for better PDF output
                element.querySelector('.download-options').remove();
                element.querySelector('.chart-upload-input').remove();
                
                // Ensure chart image is visible in PDF
                const chartImg = element.querySelector('.original-chart');
                if (chartImg) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = '<h4>Chart Screenshot</h4>';
                    tempDiv.appendChild(chartImg);
                    element.querySelector('.content-area').prepend(tempDiv);
                }

                html2pdf().from(element).set({
                    margin: 10,
                    filename: `${safeName}_Analysis.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save();
            } else {
                alert(`Cannot download ${type} for ${stockName}. Source missing.`);
            }
        }

        // Generic function to trigger file download from a URL/Base64
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Event Listeners ---
        runStocksBtn.addEventListener('click', runDailyStocks);
        generateAnalysisBtn.addEventListener('click', generateAnalysis);

    </script>

</body>
</html>
